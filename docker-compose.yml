services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - HOST=0.0.0.0
      - CORS_ORIGIN=http://localhost:5173
      # Paths inside the backend container
      - JOBS_PATH=/app/jobs
      - FONTS_PATH=/app/fonts
      # Host paths for Docker volume mounts (renderer containers need host paths)
      # PWD is resolved by docker-compose to the directory containing docker-compose.yml
      - JOBS_HOST_PATH=${PWD}/jobs
      - FONTS_HOST_PATH=${PWD}/fonts
      # Kometa-based renderer image (built from ./renderer)
      - KOMETA_RENDERER_IMAGE=kometa-preview-renderer:latest
      # Pinned Kometa version for deterministic rendering
      - KOMETA_IMAGE_TAG=${KOMETA_IMAGE_TAG:-v2.2.2}
      # Cache directory for TMDb/external API data (persists between preview runs)
      - CACHE_HOST_PATH=${PWD}/cache
      # Optional: Mount user assets
      # - USER_ASSETS_PATH=/user_assets
      # Optional: Mount user Kometa config for Original Posters
      # - USER_KOMETA_CONFIG_PATH=/user_config
    volumes:
      - ./jobs:/app/jobs
      - ./fonts:/app/fonts:ro
      - ./cache:/app/cache:rw
      - /var/run/docker.sock:/var/run/docker.sock
      # Optional: Uncomment and modify for your asset directory
      # - /path/to/your/assets:/user_assets:ro
      # Optional: Uncomment and modify for your Kometa config directory
      # - /path/to/your/kometa/config:/user_config:ro
    depends_on:
      - kometa-renderer-build
    restart: unless-stopped
    networks:
      - kometa-preview

  # Kometa-based renderer service
  # This service builds the renderer image but doesn't run as a long-lived service.
  # The backend spawns renderer containers on-demand for each preview job.
  kometa-renderer-build:
    build:
      context: ./renderer
      dockerfile: Dockerfile
      args:
        - KOMETA_IMAGE_TAG=${KOMETA_IMAGE_TAG:-v2.2.2}
    image: kometa-preview-renderer:latest
    # This service only builds the image, then exits immediately
    command: ["echo", "Renderer image built successfully"]
    restart: "no"
    networks:
      - kometa-preview

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "5173:80"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - kometa-preview

networks:
  kometa-preview:
    driver: bridge
